---
title: "Implementation Plan: lionagi Refactoring (Issue #673, v2 Vibe Edition)"
by: "@khive-implementer"
created: "2025-05-19"
updated: "2025-05-19"
version: "1.0"
doc_type: IP
output_subdir: ip
description: "Implementation plan for refactoring the lionagi package according to TDS-673-v2.md, focusing on the 'Lionagi Vibe'."
date: "2025-05-19"
issue_id: "673-v2" # Denoting it's for the v2 design
tds_path: ".khive/reports/tds/TDS-673-v2.md"
status: "Draft"
---

# Guidance

**Purpose**\
Plan out the entire coding effort before writing code. Clarify **phases**,
**tasks**, dependencies, test strategy, and acceptance criteria.

**When to Use**

- After design is approved, before actual implementation starts.

**Best Practices**

- Include TDD approach details (e.g., required test coverage).
- Provide a clear sequence of tasks.
- Reference external docs or prior designs.

---

# Implementation Plan: lionagi Refactoring (Issue #673, v2 Vibe Edition)

## 1. Overview

### 1.1 Component Purpose

This Implementation Plan details the steps to refactor the `lionagi` Python package as specified in the Technical Design Specification [`TDS-673-v2.md`](./.khive/reports/tds/TDS-673-v2.md). The primary goal is to create an intuitive, elegant, and powerful high-level abstraction layer for AI/LLM applications, embodying the "Lionagi Vibe" and leveraging `lionfuncs` and `pydapter` libraries.

### 1.2 Design Reference

The primary design document for this implementation is:
- **Technical Design Specification:** [`TDS-673-v2.md`](./.khive/reports/tds/TDS-673-v2.md) (Vibe Edition)
- **Original Research Report (Background):** [`RR-673.md`](./.khive/reports/rr/RR-673.md)

### 1.3 Implementation Approach

The implementation will follow a Test-Driven Development (TDD) methodology. Key aspects include:
- Adherence to the "Lionagi Vibe" as defined in TDS Section 1.2.
- Incremental development, focusing on one component or integration point at a time.
- Writing unit and integration tests to achieve >80% code coverage.
- Regular pre-commit checks and conventional commits.
- Collaboration with @khive-architect to resolve open questions in TDS Section 14.

## 2. Implementation Phases

### 2.1 Phase 1: Project Setup & Core Model Definition

**Description:** Establish the new directory structure and define the core Pydantic data models as specified in the TDS. This phase lays the foundation for all subsequent work.

**Key Deliverables:**
- New directory structure for `lionagi` created (TDS Section 5.6).
- Core Pydantic models (`Message`, `Tool`, `Branch` (data part), `Session` (data part), `Mail`, `Package`, `ToolCallRequest`, `ToolCallResponse`) defined in `lionagi/models/` (TDS Section 4).
- Models inherit from `pydapter.protocols.Temporal` and `pydapter.Adaptable` as specified.
- Basic `__init__.py` files and `version.py`, `py.typed`.
- `lionagi/error.py` created, defining `lionagi`-specific exceptions subclassing `lionfuncs.errors`.

**Dependencies:**
- Approved [`TDS-673-v2.md`](./.khive/reports/tds/TDS-673-v2.md).
- Availability of `lionfuncs` and `pydapter` libraries in the development environment.

**Estimated Complexity:** Medium

### 2.2 Phase 2: `lionfuncs` Integration

**Description:** Systematically replace existing `lionagi` utilities, error handling, and low-level logic with functionalities from the `lionfuncs` library.

**Key Deliverables:**
- [`lionagi/utils.py`](./lionagi/utils.py:1) largely deprecated; functionalities replaced by `lionfuncs.utils`, `lionfuncs.async_utils`, `lionfuncs.typing_utils`. Minimal `lionagi.core.utils` if absolutely necessary.
- [`lionagi/_errors.py`](./lionagi/_errors.py:1) replaced by usage of `lionfuncs.errors` and new `lionagi.error.py`.
- [`lionagi/libs/`](./lionagi/libs/:1) (file, parse, schema, validate, nested, package) functionalities replaced by `lionfuncs` equivalents.
- `lionagi/libs/token_transform/` refactored into `lionagi.core.text_processing` or similar if deemed core, with internal `lionfuncs` usage.
- Concurrency mechanisms refactored to use `lionfuncs.concurrency` and `lionfuncs.async_utils`.
- Provider-specific SDK logic in `lionagi/service/providers/` refactored to use `lionfuncs.network.adapters` via a new `lionagi.core.service_interface.ServiceInterface`.
- `lionagi.services.factory` created for configuring `ServiceInterface` instances.

**Dependencies:**
- Phase 1 completion.
- `lionfuncs` library.

**Estimated Complexity:** High

### 2.3 Phase 3: `pydapter` Integration

**Description:** Integrate `pydapter` for all data adaptation tasks and enhance Pydantic models.

**Key Deliverables:**
- [`lionagi/adapters/`](./lionagi/adapters/:1) directory removed; functionalities replaced by `pydapter`.
- Core Pydantic models from Phase 1 inherit `pydapter.Adaptable` as specified in TDS Section 5.2.
- `Pile` class (likely in `lionagi.core.collections`) refactored to use `pydapter` for its data adaptation methods (e.g., `to_df`, `to_json_file`).

**Dependencies:**
- Phase 1 completion.
- `pydapter` library.

**Estimated Complexity:** Medium

### 2.4 Phase 4: Refactor Core Concepts & Behavioral Logic

**Description:** Implement the behavioral aspects of core `lionagi` concepts like `Session` and `Branch`, and their internal manager components.

**Key Deliverables:**
- `lionagi.core.session.Session` class implemented (behavioral part), interacting with its Pydantic model.
- `lionagi.core.branch.Branch` class implemented (behavioral part), interacting with its Pydantic model.
- Internal manager classes (`MessageManager`, `ActionManager`, `iModelManager` (if distinct from `ServiceInterface`), `MailManager`) implemented in `lionagi.core/`, utilizing `lionfuncs` and operating on new Pydantic models.
- `Pile`-like structure for message management within `Branch` (via `MessageManager`) implemented.
- Public API methods for `Session` and `Branch` (e.g., `chat`, `operate`, `ReAct`, `register_tools`, `new_branch`) implemented.

**Dependencies:**
- Phase 1, 2, 3 completion.

**Estimated Complexity:** High

### 2.5 Phase 5: API Finalization, `__init__`, and Settings

**Description:** Finalize public exports, settings, and ensure overall package coherence.

**Key Deliverables:**
- [`lionagi/__init__.py`](./lionagi/__init__.py:1) updated to export the new public API (`Session`, `Branch`, `Message`, `Tool`, `Service` factory).
- [`lionagi/settings.py`](./lionagi/settings.py:1) reviewed, simplified, or removed if all settings are handled by explicit configuration or `lionfuncs` env var reading.
- Relocation of "Endpoint" and "Reader" functionalities confirmed by removing related code.

**Dependencies:**
- Phase 4 completion.

**Estimated Complexity:** Low

### 2.6 Phase 6: Comprehensive Testing & Documentation (TI)

**Description:** Write comprehensive unit and integration tests to meet coverage goals. Create the Test Information document.

**Key Deliverables:**
- Unit tests for all new/refactored modules and classes.
- Integration tests for core workflows (`chat`, `operate`, `ReAct`, tool usage).
- Test coverage >80%.
- Test Information document ([`TI-673-v2.md`](./.khive/reports/ti/TI-673-v2.md)) created and populated.

**Dependencies:**
- Phase 5 completion.

**Estimated Complexity:** High

## 3. Test Strategy

### 3.1 Unit Tests

Focus on individual components in isolation.
- **Models (`lionagi.models.*`):** Test Pydantic validation, default values, `Temporal` and `Adaptable` integration (mocking `pydapter` specifics if needed).
- **Core Logic (`lionagi.core.*`):**
    - `Session`, `Branch`: Test methods with mocked internal managers and service interfaces. Verify state changes and correct delegation.
    - `MessageManager`, `ActionManager`: Test their logic with mocked dependencies (e.g., `lionfuncs` calls, tool functions).
    - `ServiceInterface`: Test request/response transformation logic with mocked `lionfuncs.network.adapter` behavior.
- **Utilities (`lionagi.core.utils`, `lionagi.error`):** Test any remaining specific utilities and custom exception definitions.

#### 3.1.1 Test Group: Data Models (`lionagi.models`)

| ID    | Description                                                                 | Fixtures/Mocks                                  | Assertions                                                              |
| ----- | --------------------------------------------------------------------------- | ----------------------------------------------- | ----------------------------------------------------------------------- |
| UT-M1 | Test `Message` creation with valid roles and content types (TDS Sec 4)      | None                                            | Model validates, `id`/`timestamp` populated                             |
| UT-M2 | Test `Message` validation failure for invalid content per role (TDS Sec 4)  | None                                            | `ValueError` raised                                                     |
| UT-M3 | Test `Tool` model creation and schema alias (TDS Sec 4)                     | Mock `function_to_openai_schema` if auto-gen    | Model validates, `schema_` (aliased to `schema`) populated              |
| UT-M4 | Test `Branch` (model) and `Session` (model) default values and structure    | None                                            | Models validate, default factories work (e.g., `messages=[]`)           |
| UT-M5 | Test `Adaptable` behavior for key models (e.g., `Message.adapt_to("json")`) | Mock `pydapter.core.adapt_to_obj`               | Correct `pydapter` methods called, expected output (mocked)             |

#### 3.1.2 Test Group: Core Logic (`lionagi.core.branch.Branch` behavior)

| ID    | Description                                                              | Fixtures/Mocks                                                                 | Assertions                                                                                                |
| ----- | ------------------------------------------------------------------------ | ------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------- |
| UT-B1 | Test `Branch.chat()` basic flow (no tools)                               | Mock `ServiceInterface.call_llm`, Mock `MessageManager.add_message`            | User/Assistant messages added, `ServiceInterface` called correctly, assistant message returned          |
| UT-B2 | Test `Branch.register_tools()`                                           | Mock `ActionManager.register_tool`                                             | `ActionManager.register_tool` called with correct `Tool` object(s)                                        |
| UT-B3 | Test `Branch.chat()` with simple tool call (LLM requests tool)           | Mock `ServiceInterface` (to return tool request), Mock `ActionManager.execute_tool` | Tool request message created, `ActionManager` called, tool response message created, LLM called again |
| UT-B4 | Test `Branch.add_message()`                                              | Mock `MessageManager.add_message`                                              | `MessageManager.add_message` called with correct `Message` object                                         |

### 3.2 Integration Tests

Focus on interactions between components.
- **Core Workflows:** Test `Session.new_branch().chat()`, `Branch.operate()`, `Branch.ReAct()` end-to-end with mocked LLM responses (simulating `lionfuncs.network.adapter` output).
- **`lionfuncs`/`pydapter` Integration:** Verify that `lionagi` components correctly use mocked `lionfuncs` utilities and `pydapter` adaptation.
- **Error Handling:** Test how `lionagi` handles errors raised by mocked `lionfuncs` or `pydapter`.

#### 3.2.1 Test Group: Chat Workflows

| ID   | Description                                                                    | Setup                                                                                                | Assertions                                                                                                                               |
| ---- | ------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| IT-C1| Test full `chat` flow (user -> LLM -> assistant)                               | `Session` with a `Branch`, Mocked `ServiceInterface` to return simple assistant message              | Correct sequence of messages in `Branch.messages`, expected assistant response.                                                          |
| IT-C2| Test full `chat` flow with one tool call & successful execution                | `Session`, `Branch` with a registered mock tool, Mocked `ServiceInterface` to request tool & then respond | Tool requested, mock tool executed, tool response sent to LLM, final assistant response received.                                       |
| IT-C3| Test `chat` flow with tool call where tool execution raises an error           | `Session`, `Branch` with a mock tool that raises an error, Mocked `ServiceInterface`                 | Tool requested, mock tool error captured, `ToolCallResponse` with `is_error=True` sent to LLM, LLM potentially responds about the error. |

### 3.3 Mock and Stub Requirements

| Dependency                      | Mock/Stub Type | Key Behaviors to Mock                                                                                                |
| ------------------------------- | -------------- | -------------------------------------------------------------------------------------------------------------------- |
| `lionfuncs.utils.*`             | Mock           | Return values for specific utility functions used.                                                                   |
| `lionfuncs.async_utils.*`       | Mock           | Behavior of `alcall`, `bcall`, decorators like `@max_concurrent`.                                                      |
| `lionfuncs.network.adapters.*`  | Mock           | LLM API responses (text, tool calls, errors), simulating `call_llm` method outputs.                                  |
| `lionfuncs.errors.*`            | Mock (raising) | Simulate specific `lionfuncs` errors being raised.                                                                     |
| `lionfuncs.schema_utils.*`      | Mock           | Return value for `function_to_openai_schema`.                                                                        |
| `pydapter.Adaptable.*`          | Mock           | Behavior of `adapt_to`, `adapt_from` if testing `Adaptable` integration points directly.                             |
| `pydapter.core.adapters.*`      | Mock           | Behavior of specific adapters (e.g., `DataFrameAdapter`) if `Pile.to_df` uses them directly.                         |
| User-defined Tool `func`        | Mock           | Return values or side effects of tools registered for testing tool call mechanisms.                                  |

## 4. Implementation Tasks

### 4.1 Phase 1: Project Setup & Core Model Definition
| ID    | Task                                                                 | Description                                                                                                | Dependencies | Priority | Complexity |
| ----- | -------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- | ------------ | -------- | ---------- |
| T1-1  | Create new `lionagi` directory structure (per TDS 5.6)               | Set up folders: `core/`, `models/`, `services/`, `tools/`, `error.py`, `__init__.py`, `version.py`, `py.typed`. | None         | High     | Low        |
| T1-2  | Define `MessageRole` Enum (TDS Sec 4)                                | In `lionagi/models/message.py` (or `lionagi/models/base.py`).                                              | T1-1         | High     | Low        |
| T1-3  | Define `ToolCallRequest`, `ToolCallResponse` Pydantic models         | In `lionagi/models/message.py`, inheriting `Temporal`.                                                     | T1-1, T1-2   | High     | Medium     |
| T1-4  | Define `Message` Pydantic model                                      | In `lionagi/models/message.py`, inheriting `Temporal`, `Adaptable`, with content validator.                | T1-1, T1-3   | High     | Medium     |
| T1-5  | Define `Tool` Pydantic model                                         | In `lionagi/models/tool.py`, inheriting `Temporal`, `Adaptable`.                                           | T1-1         | High     | Medium     |
| T1-6  | Define `ServiceInterface` Pydantic model (abstract)                  | In `lionagi/models/base.py` or `lionagi/core/service_interface.py`.                                        | T1-1         | High     | Low        |
| T1-7  | Define `Branch` Pydantic model (data part)                           | In `lionagi/models/branch.py`, inheriting `Temporal`, `Adaptable`.                                         | T1-1, T1-4, T1-5 | High   | Medium     |
| T1-8  | Define `Session` Pydantic model (data part)                          | In `lionagi/models/session.py`, inheriting `Temporal`, `Adaptable`.                                        | T1-1, T1-7   | High     | Medium     |
| T1-9  | Define `Package` and `Mail` Pydantic models                          | In `lionagi/models/mail.py`, inheriting `Temporal`, `Adaptable`.                                           | T1-1         | Medium   | Medium     |
| T1-10 | Create `lionagi/error.py` with custom exceptions                     | Subclass `lionfuncs.LionError` as needed (e.g., `LionagiSessionError`).                                    | T1-1         | High     | Low        |

### 4.2 Phase 2: `lionfuncs` Integration
| ID    | Task                                                              | Description                                                                                                                               | Dependencies | Priority | Complexity |
| ----- | ----------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | ------------ | -------- | ---------- |
| T2-1  | Refactor/remove [`lionagi/utils.py`](./lionagi/utils.py:1)        | Replace with `lionfuncs` calls. Create `lionagi.core.utils` for any essential, non-transferable utils.                                    | T1-all       | High     | Medium     |
| T2-2  | Replace [`lionagi/_errors.py`](./lionagi/_errors.py:1)            | Use exceptions from `lionagi.error.py` (which use `lionfuncs.errors`). Update try/catch blocks.                                           | T1-10        | High     | Low        |
| T2-3  | Remove [`lionagi/libs/`](./lionagi/libs/:1) submodules            | Systematically replace functionalities (file, parse, schema, validate) with `lionfuncs` equivalents.                                      | T1-all       | High     | High       |
| T2-4  | Refactor `token_transform` if kept                                | If `lionagi/libs/token_transform/` is kept, move to `lionagi.core.text_processing` and refactor internals to use `lionfuncs`.             | T2-3         | Medium   | Medium     |
| T2-5  | Implement `lionagi.core.service_interface.ServiceInterface`       | Wrapper around `lionfuncs.network.adapters` (e.g., `OpenAIAdapter`). Handles request/response translation.                                | T1-6, T1-4   | High     | Medium     |
| T2-6  | Implement `lionagi.services.factory.Service`                      | Factory functions (e.g., `Service.OpenAI()`) to create configured `ServiceInterface` instances.                                           | T2-5         | High     | Medium     |
| T2-7  | Refactor concurrency logic                                        | Update any internal concurrency (e.g., for future `ActionManager`) to use `lionfuncs.concurrency` / `lionfuncs.async_utils`.                | T1-all       | High     | Medium     |

### 4.3 Phase 3: `pydapter` Integration
| ID   | Task                                                              | Description                                                                                                | Dependencies | Priority | Complexity |
| ---- | ----------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- | ------------ | -------- | ---------- |
| T3-1 | Remove [`lionagi/adapters/`](./lionagi/adapters/:1)                | Ensure all previous adapter functionality is covered by `pydapter` or direct model methods.                | T1-all       | High     | Low        |
| T3-2 | Ensure core models inherit `pydapter.Adaptable`                   | Verify `Message`, `Tool`, `Branch` (model), `Session` (model), `Package`, `Mail` correctly use `Adaptable`.  | T1-all       | High     | Low        |
| T3-3 | Refactor `Pile` data adaptation                                   | If `Pile` concept is implemented in `lionagi.core.collections`, ensure its `to_df`, `to_json` etc. use `pydapter`. | T1-all       | Medium   | Medium     |

### 4.4 Phase 4: Refactor Core Concepts & Behavioral Logic
| ID    | Task                                                              | Description                                                                                                                               | Dependencies    | Priority | Complexity |
| ----- | ----------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | --------------- | -------- | ---------- |
| T4-1  | Implement `lionagi.core.message_manager.MessageManager`           | Manages `Message` collections (Pile-like). Operates on `Message` models. Uses `lionfuncs.utils` for list/dict ops.                          | T1-4, T2-1      | High     | Medium     |
| T4-2  | Implement `lionagi.core.action_manager.ActionManager`             | Manages `Tool` registration & execution. Uses `lionfuncs.schema_utils` for schema gen, `lionfuncs.async_utils` for concurrent calls.      | T1-5, T2-1, T2-7| High     | High       |
| T4-3  | Implement `lionagi.core.branch.Branch` (behavioral)               | Implement methods: `__init__`, `chat`, `instruct`, `operate`, `ReAct`, `add_message`, `register_tools`. Uses `MessageManager`, `ActionManager`, `ServiceInterface`. | T1-7, T2-5, T4-1, T4-2 | High   | High       |
| T4-4  | Implement `lionagi.core.session.Session` (behavioral)             | Implement methods: `__init__`, `new_branch`, `get_branch`, `default_branch` property. Manages `Branch` instances.                           | T1-8, T4-3      | High     | Medium     |
| T4-5  | Implement Mail System (`MailManager`, `Mailbox` in `Branch`)      | If retained: `lionagi.core.mail_manager.MailManager` and `Mailbox` logic within `Branch`. Uses `Package`, `Mail` models.                   | T1-9, T2-7      | Medium   | Medium     |

### 4.5 Phase 5: API Finalization, `__init__`, and Settings
| ID   | Task                                                              | Description                                                                                                | Dependencies | Priority | Complexity |
| ---- | ----------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- | ------------ | -------- | ---------- |
| T5-1 | Update [`lionagi/__init__.py`](./lionagi/__init__.py:1)           | Export `Session` (from `lionagi.core.session`), `Branch` (from `lionagi.core.branch`), `Message`, `Tool` (from `lionagi.models`), `Service` (from `lionagi.services.factory`). | T4-all       | High     | Low        |
| T5-2 | Review/simplify/remove [`lionagi/settings.py`](./lionagi/settings.py:1) | Remove obsolete settings. Default to explicit config or `lionfuncs` env var reading.                       | All previous | Medium   | Low        |
| T5-3 | Remove "Endpoint" and "Reader" code                               | Ensure all code related to old endpoint/reader functionalities is deleted.                                 | All previous | High     | Low        |

### 4.6 Phase 6: Comprehensive Testing & Documentation (TI)
| ID   | Task                                                              | Description                                                                                                | Dependencies | Priority | Complexity |
| ---- | ----------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- | ------------ | -------- | ---------- |
| T6-1 | Write Unit Tests for `lionagi.models`                             | Cover validation, defaults, `Adaptable` behavior.                                                          | T1-all       | High     | Medium     |
| T6-2 | Write Unit Tests for `lionagi.core` components                    | Test `Session`, `Branch`, `MessageManager`, `ActionManager`, `ServiceInterface` logic with mocks.          | T4-all       | High     | High       |
| T6-3 | Write Integration Tests for core workflows                        | Test `chat`, `operate`, `ReAct` with mocked LLM responses. Test tool call lifecycle.                       | T4-all       | High     | High       |
| T6-4 | Achieve >80% test coverage                                        | Run coverage reports and add tests as needed.                                                              | T6-1, T6-2, T6-3 | High   | Medium     |
| T6-5 | Create and populate Test Information document (`TI-673-v2.md`)    | Document test strategy, cases, and results.                                                                | T6-4         | High     | Medium     |

## 5. Implementation Sequence

```mermaid
gantt
    title lionagi Refactoring (v2) Implementation Sequence
    dateFormat  YYYY-MM-DD
    axisFormat %m-%d

    section Phase 1: Setup & Models (5d)
    Directory Structure      :p1_t1, 2025-05-20, 1d
    Pydantic Models Def      :p1_t2, after p1_t1, 3d
    Error Module             :p1_t3, after p1_t1, 1d

    section Phase 2: lionfuncs Integration (7d)
    Utils & Errors Refactor  :p2_t1, after p1_t3, 2d
    Libs Replacement         :p2_t2, after p2_t1, 3d
    Service Intf. & Factory  :p2_t3, after p2_t2, 2d

    section Phase 3: pydapter Integration (3d)
    Adapters Removal         :p3_t1, after p1_t2, 1d
    Models use Adaptable     :p3_t2, after p3_t1, 1d
    Pile Adaptation          :p3_t3, after p3_t2, 1d
    
    section Phase 4: Core Logic (10d)
    MessageManager Impl.     :p4_t1, after p1_t2, 2d
    ActionManager Impl.      :p4_t2, after p1_t2, 3d
    Branch Behavior Impl.    :p4_t3, after p4_t1, after p4_t2, after p2_t3, 5d
    Session Behavior Impl.   :p4_t4, after p4_t3, 2d
    Mail System (Optional)   :p4_t5, after p4_t4, 2d

    section Phase 5: Finalization (2d)
    Update __init__.py       :p5_t1, after p4_t4, 1d
    Settings & Cleanup       :p5_t2, after p5_t1, 1d

    section Phase 6: Testing & TI Doc (7d)
    Unit Tests Models        :p6_t1, during p1_t2, 3d
    Unit Tests Core          :p6_t2, during p4_t3, 4d
    Integration Tests        :p6_t3, after p4_t4, 3d
    Coverage & TI Doc        :p6_t4, after p6_t3, 2d
```
*(Note: Gantt dates are illustrative starting from tomorrow; durations are estimates. Some testing can be parallel.)*

## 6. Acceptance Criteria

### 6.1 Component Level
| ID   | Criterion                                                                 | Validation Method                                     |
| ---- | ------------------------------------------------------------------------- | ----------------------------------------------------- |
| AC-1 | `lionagi` package structure matches TDS Section 5.6.                      | Code review, file system check.                       |
| AC-2 | Core Pydantic models (`Message`, `Tool`, etc.) are defined as per TDS Sec 4. | Unit tests (UT-M*), code review.                    |
| AC-3 | `lionfuncs` is correctly integrated for utils, errors, SDKs (TDS Sec 5.1).| Unit tests for components using `lionfuncs`, code review. |
| AC-4 | `pydapter` is correctly integrated for data models (TDS Sec 5.2).         | Unit tests for `Adaptable` models, code review.       |
| AC-5 | `Session` and `Branch` classes provide public API as per TDS Sec 3.       | Unit/Integration tests (UT-B*, IT-C*).                |
| AC-6 | Core workflows (`chat`, `operate`, tool use) function as expected.        | Integration tests (IT-C*).                            |
| AC-7 | Test coverage is >80%.                                                    | Coverage report (`pytest --cov`).                     |
| AC-8 | All pre-commit hooks pass (`uv run pre-commit run --all-files`).          | Local pre-commit execution, CI.                       |
| AC-9 | `IP-673-v2.md` and `TI-673-v2.md` are completed and accurate.             | Document review.                                      |

### 6.2 "Lionagi Vibe"
| ID    | Criterion                                                                 | Validation Method                                                                 |
| ----- | ------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| AC-V1 | API is intuitive, Pythonic, and exposes powerful primitives (`Session`, `Branch`). | Code review, example usage review by @khive-architect and potentially other team members. |
| AC-V2 | Conceptual integrity of `Pile`, `Mail` (if retained) is preserved.        | Code review of `MessageManager` and `MailManager` implementations.                |
| AC-V3 | Tooling is a central and seamless part of `Branch` operations.            | Review of `ActionManager` and `Branch.chat/operate` integration with tools.       |

## 7. Test Implementation Plan

### 7.1 Test Implementation Sequence
1.  Implement Pydantic model unit tests (alongside Phase 1 model definitions).
2.  Implement unit tests for `lionfuncs` and `pydapter` integration points as they are developed (during Phases 2 & 3).
3.  Implement unit tests for `lionagi.core` components (`Session`, `Branch` behaviors, managers) as they are developed (during Phase 4).
4.  Develop integration tests for core workflows once major components are in place (towards end of Phase 4 / start of Phase 6).
5.  Continuously monitor test coverage and add tests to meet >80% target (during Phase 6).

### 7.2 Test Code Examples
*(Illustrative examples based on TDS)*

#### Unit Test Example (Model Validation)
```python
# tests/models/test_message.py
import pytest
from lionagi.models.message import Message, MessageRole, ToolCallRequest # Assuming final paths
from pydantic import ValidationError

def test_message_tool_request_valid_content():
    tc_req = ToolCallRequest(function_name="test_func", arguments={"arg1": "val1"})
    msg = Message(role=MessageRole.TOOL_REQUEST, content=[tc_req])
    assert isinstance(msg.content[0], ToolCallRequest)

def test_message_tool_request_invalid_content_type():
    with pytest.raises(ValidationError): # Pydantic's ValidationError
        Message(role=MessageRole.TOOL_REQUEST, content="not a list")
```

#### Integration Test Example (Simplified Chat with Mocked LLM)
```python
# tests/core/test_branch_integration.py
import pytest
from unittest.mock import MagicMock
from lionagi.core.branch import Branch # Assuming final path
from lionagi.models.message import Message, MessageRole
# from lionagi.core.service_interface import ServiceInterface # Path to be confirmed

@pytest.mark.asyncio
async def test_branch_chat_simple_assistant_response():
    # Arrange
    mock_service_interface = MagicMock() # Replace with actual ServiceInterface mock
    # Simulate LLM responding with a simple text message
    mock_service_interface.call_llm = MagicMock(return_value=(
        {"role": "assistant", "content": "Hello back!"}, None # (response_content, error)
    ))
    
    branch = Branch(service_config={"provider": "mock"}) # Actual service config might differ
    branch.service = mock_service_interface # Inject mock

    # Act
    assistant_msg = await branch.chat("Hello")

    # Assert
    assert len(branch.messages) == 2 # User message + Assistant message
    assert branch.messages[0].role == MessageRole.USER
    assert branch.messages[0].content == "Hello"
    assert assistant_msg.role == MessageRole.ASSISTANT
    assert assistant_msg.content == "Hello back!"
    mock_service_interface.call_llm.assert_called_once()
```

## 8. Implementation Risks and Mitigations
*(Refer to TDS Section 13 for detailed risks. Key mitigations include early feedback, thorough testing, and close collaboration.)*

| Risk                                       | Mitigation                                                                                                  |
| ------------------------------------------ | ----------------------------------------------------------------------------------------------------------- |
| "Vibe" Misalignment Despite Efforts        | Early feedback on API/examples, clear documentation, "golden path" examples.                                |
| Integration Complexity (`lionfuncs`/`pydapter`) | Thorough integration testing, collaboration with lib teams, temporary local utils if critical gaps.       |
| Loss of Valued Power/Flexibility           | Careful review of existing protocols' intent, preserve expressive power, solicit feedback on deprecations.    |
| Performance Issues from Dependencies       | Basic benchmarking, report issues to lib maintainers, minimize `lionagi` overhead.                          |
| `pydapter.protocols.Temporal` Maturity     | Early testing, communication with `pydapter` team, temporary local `Identifiable` as fallback.              |

## 9. Dependencies and Environment

### 9.1 External Libraries
*(As per TDS Section 2.2)*
| Library    | Version | Purpose                                                                 |
| ---------- | ------- | ----------------------------------------------------------------------- |
| python     | >=3.9   | Core language                                                           |
| lionfuncs  | [latest]| Utilities, async, concurrency, network, errors, schema gen              |
| pydapter   | [latest]| Data adaptation, `Adaptable` mixin, `Temporal` protocol                 |
| pydantic   | [latest]| Data validation and models                                              |

### 9.2 Environment Setup
```bash
# Create virtual environment using uv (recommended)
uv venv .venv
source .venv/bin/activate

# Install dependencies (assuming they are in pyproject.toml)
uv pip install -e .[dev] # Or however project dependencies are managed

# Set up any necessary environment variables for LLM API keys
# export OPENAI_API_KEY="your_key_here" 
# (Handled by lionfuncs, ensure they are set for testing/running)
```

## 10. Additional Resources

### 10.1 Design Document
- [`TDS-673-v2.md`](./.khive/reports/tds/TDS-673-v2.md)

### 10.2 Research Report
- [`RR-673.md`](./.khive/reports/rr/RR-673.md)

### 10.3 Relevant `lionagi` (Current) Code for "Vibe" Inspiration
- [`lionagi/session/`](./lionagi/session/:1)
- [`lionagi/protocols/`](./lionagi/protocols/:1)
- [`tests/operations/`](./tests/operations/:1)

## 11. Open Questions from TDS (Section 14)
*(To be discussed with @khive-architect as implementation progresses)*
1.  Final list of `lionagi/libs/token_transform/` functionalities.
2.  Detailed API for `lionagi.Service` factory for advanced `lionfuncs.network.adapters` config.
3.  Default persistence strategy for `Session`/`Branch` (baseline: file-based JSON via `pydapter`).
4.  Necessity and scope of `lionagi/tools/` directory (built-in tools).
5.  Exact structure of `pydapter.protocols.Temporal` (confirm field names/types).
